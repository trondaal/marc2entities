<?xml version="1.0" encoding="UTF-8"?>
<templates 
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xsi:noNamespaceSchemaLocation="../../xsd/marc2lrm.rules.xsd">
    <!-- keyfilter is used to remove punctuation etc. from the values that are used in the keystring -->
    <keyfilter>lower-case(replace($key, ' ', ''))</keyfilter>
    <!-- PERSONS -->
    <entity tag="100" condition="*:subfield/@code = '1p'" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-100-Person" label="Person">
        <note>Creator identified with the help of field 100</note>
        <attributes>
            <datafield tag="100">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='100'])</element>
        </key>
        <relationships>
            <!-- Person to work relationship  -->
            <!--<relationship condition="not(*:subfield[@code = '4'])" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-240-Work"/>
                <target entity="MARC21-245-Work"/>
            </relationship>-->
            <relationship condition="not(*:subfield[@code = '4']) " type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-240-Work"/>            
            </relationship>
            <relationship condition="*:subfield[@code = '4'] = ('aut')" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-240-Work"/>
                <target entity="MARC21-245-Work"/>
                <target entity="MARC21-700-Work" condition="frbrizer:linked($this_field, $target_field)"/>                
            </relationship>
            <relationship condition="*:subfield[@code = '4'] = ('drt')" type="http://rdaregistry.info/Elements/a/P50048" itype="http://rdaregistry.info/Elements/w/P10013">
                <target entity="MARC21-240-Work"/>
                <target entity="MARC21-245-Work"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="600" condition="*:subfield/@code = '1p'" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-600-Person" label="Person">
        <note>Person in a subject entry</note>
        <attributes>
            <datafield tag="600">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='600'])</element>
        </key>
        <relationships>
            <!-- Person to work relationship  -->
            <relationship condition="not(*:subfield[@code = '4'])" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-600-Work" same-field="true"/>
            </relationship>
            <relationship condition="*:subfield[@code = '4'] = ('aut')" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-600-Work"  same-field="true"/>
            </relationship>
            <relationship condition="*:subfield[@code = '4'] = ('drt')" type="http://rdaregistry.info/Elements/a/P50048" itype="http://rdaregistry.info/Elements/w/P10013">
                <target entity="MARC21-600-Work"  same-field="true"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="700" condition="*:subfield/@code = '1p' and *:subfield[@code='4'] = ('aut', 'drt', 'act', 'trl', 'nrt', 'act')" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-700-Person" label="Person">
        <note>Person in 700 field (the role and relationship for the person is defined using relationship rules)</note>
        <attributes>
            <datafield tag="700">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="4" type="relator code"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='700'])</element>
        </key>
        <relationships>
            <!-- Person to work relationship  -->
            <!--<relationship condition="not(*:subfield[@code = '4'])" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-700-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-240-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-245-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
            </relationship>-->
            <relationship condition="not(*:subfield[@code = '4'])" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-700-Work" same-field="true"/>
            </relationship>
            <relationship condition="*:subfield[@code = '4'] = ('aut')" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-700-Work" condition="(frbrizer:linked-strict($this_field, $target_field))"/>
                <target entity="MARC21-240-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-245-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-130-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
            </relationship>
            <relationship condition="*:subfield[@code = '4'] = ('aui')" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-700-Work" condition="(frbrizer:linked($this_field, $target_field))" same-field="true"/>
            </relationship>
            <relationship condition="*:subfield[@code = '4'] = ('drt')" type="http://rdaregistry.info/Elements/a/P50048" itype="http://rdaregistry.info/Elements/w/P10013">
                <target entity="MARC21-700-Work" condition="(frbrizer:linked-strict($this_field, $target_field))"/>
                <target entity="MARC21-240-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-245-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-130-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
            </relationship>
            <!-- Person to expression -->
            <relationship condition="*:subfield[@code = '4'] = ('trl')" type="http://rdaregistry.info/Elements/a/P50145" itype="http://rdaregistry.info/Elements/e/P20037">
                <target entity="MARC21-700-Expression" condition="(frbrizer:linked-strict($this_field, $target_field))"/>
                <target entity="MARC21-240-Expression" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-245-Expression" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-130-Expression" condition="(frbrizer:linked($this_field, $target_field))"/>
            </relationship>          
            <relationship condition="*:subfield[@code = '4'] = ('nrt')" type="http://rdaregistry.info/Elements/a/P50608" itype="http://rdaregistry.info/Elements/e/P20378">
                <target entity="MARC21-700-Expression" condition="(frbrizer:linked-strict($this_field, $target_field))"/>
                <target entity="MARC21-240-Expression" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-245-Expression" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-130-Expression" condition="(frbrizer:linked($this_field, $target_field))"/>
            </relationship>
            <relationship condition="*:subfield[@code = '4'] = ('act')" type="http://rdaregistry.info/Elements/a/P50071" itype="http://rdaregistry.info/Elements/e/P20012">
                <target entity="MARC21-700-Expression" condition="(frbrizer:linked-strict($this_field, $target_field))"/>
                <target entity="MARC21-240-Expression" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-245-Expression" condition="(frbrizer:linked($this_field, $target_field))"/>
                <target entity="MARC21-130-Expression" condition="(frbrizer:linked($this_field, $target_field))"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="800" condition="*:subfield/@code = '1p'" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-800-Person" label="Person">
        <note>Person in 800 field (the role and relationship for the person is defined using relationship rules)</note>
        <attributes>
            <datafield tag="800">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='800'])</element>
        </key>
        <relationships>
            <!-- Person to work relationship  -->
            <relationship condition="not(*:subfield[@code = '4'])" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-800-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
            </relationship>
            <relationship condition="*:subfield[@code = '4'] = ('aut')" type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-800-Work" condition="(frbrizer:linked($this_field, $target_field))"/>
            </relationship>
        </relationships>
    </entity>
    
    <!-- WORKS -->
    
    <entity tag="130" condition="*:subfield/@code = '1w'" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-130-Work" label="Work">
        <note>Work identified by title in 240</note>
        <attributes>
            <datafield tag="130">
                <!-- Joining title $a and name of part $p to one string -->
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
            <datafield tag="380" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='130'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/w/P10078" itype="http://rdaregistry.info/Elements/e/P20231" label="has expression of work" ilabel="has work expressed">
                <target entity="MARC21-130-Expression" same-field="true"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10019" itype="http://rdaregistry.info/Elements/w/P10147">
                <target entity="MARC21-800-Work"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10019" itype="http://rdaregistry.info/Elements/w/P10147">
                <target entity="MARC21-830-Work"/>
            </relationship>
            <relationship type="{$target_field/*:subfield[@code = '4']}">
                <target entity="MARC21-700-Work-Related"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10261" itype="http://rdaregistry.info/Elements/a/P50249">
                <target entity="MARC21-600-Person"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10257" itype="http://rdaregistry.info/Elements/w/P10264">
                <target entity="MARC21-600-Work"/>
            </relationship>
        </relationships>
    </entity>
    
    
    <entity tag="240" condition="*:subfield/@code = '1w'"  type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-240-Work" label="Work">
        <note>Work identified by title in 240</note>
        <attributes>
            <datafield tag="240">
                <!-- Joining title $a and name of part $p to one string -->
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
            <datafield tag="380" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='240'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/w/P10078" itype="http://rdaregistry.info/Elements/e/P20231" label="has expression of work" ilabel="has work expressed">
                <target entity="MARC21-240-Expression" same-field="true"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10019" itype="http://rdaregistry.info/Elements/w/P10147">
                <target entity="MARC21-800-Work"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10019" itype="http://rdaregistry.info/Elements/w/P10147">
                <target entity="MARC21-830-Work"/>
            </relationship>
            <relationship type="{$target_field/*:subfield[@code = '4']}">
                <target entity="MARC21-700-Work-Related"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10261" itype="http://rdaregistry.info/Elements/a/P50249">
                <target entity="MARC21-600-Person"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10257" itype="http://rdaregistry.info/Elements/w/P10264">
                <target entity="MARC21-600-Work"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="245"  condition="false()" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-245-Work" label="Work">
        <note>Work identified by title in 245</note>
        <attributes>
            <datafield tag="245">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'b']), frbrizer:trim(../*:subfield[@code = 'c'])), ' : ')" label="has title of the work"/>
            </datafield>
            <datafield tag="380" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='245'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/w/P10078" itype="http://rdaregistry.info/Elements/e/P20231" label="has expression of work" ilabel="has work expressed">
                <target entity="MARC21-245-Expression" same-field="true"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10019" itype="http://rdaregistry.info/Elements/w/P10147">
                <target entity="MARC21-800-Work"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10019" itype="http://rdaregistry.info/Elements/w/P10147">
                <target entity="MARC21-830-Work"/>
            </relationship>
            <relationship type="{$target_field/*:subfield[@code = '4']}">
                <target entity="MARC21-700-Work-Related"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10261" itype="http://rdaregistry.info/Elements/a/P50249">
                <target entity="MARC21-600-Person"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10257" itype="http://rdaregistry.info/Elements/w/P10264">
                <target entity="MARC21-600-Work"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="600" condition="*:subfield/@code = '1w'" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-600-Work" label="Work">
        <note>Work identified by title in 600</note>
        <attributes>
            <datafield tag="600">
                <!-- Joining title $a and name of part $p to one string -->
                <subfield code="t" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
            <datafield tag="380" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='600'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
    </entity>
    
    <entity tag="700" condition="*:subfield/@code = '1w' and @ind2='2' and *:subfield[@code='t'] and not(*:subfield[@code='i'])" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-700-Work" label="Work">
        <note>Analytical work</note>
        <attributes>
            <datafield tag="700" >
                <!-- Joining title $t and name of part $p to one string -->
                <subfield code="t" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
            <datafield tag="380" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='700'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>
            <!-- All works with ind2=2 are embodied and have expressions -->
            <relationship type="http://rdaregistry.info/Elements/w/P10078" itype="http://rdaregistry.info/Elements/e/P20231" label="has expression of work" ilabel="has work expressed">
                <target entity="MARC21-700-Expression" same-field="true"/>
            </relationship>
            <!-- If target has $4 and ind2 ne '2' then it is a related work, and field linked -->
            <relationship type="{$target_field/*:subfield[@code='4']}">
                <target entity="MARC21-700-Work-Related" condition="$target_field/*:subfield[@code='t'] and frbrizer:linked($this_field, $target_field)" same-field="false"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="700" condition="*:subfield/@code = '1w' and @ind2 ne '2' and *:subfield[@code='t'] and *:subfield[@code=('4')]" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-700-Work-Related" label="Work">
        <note>Work identified by title in 700</note>
        <attributes>
            <datafield tag="700">
                <!-- Joining title $a and name of part $p to one string -->
                <subfield code="t" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
            <datafield tag="380" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='700'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>
        </relationships>
    </entity>
    
    <entity tag="800"  condition="*:subfield/@code = '1w'" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-800-Work" label="Work">
        <note>Work identified by title in 800</note>
        <attributes>
            <datafield tag="800">
                <!-- Joining title $a and name of part $p to one string -->
                <subfield code="t" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='800'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>
        </relationships>
    </entity>
    
    <entity tag="830" condition="*:subfield/@code = '1w'" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-830-Work" label="Work">
        <note>Work identified by title in 800</note>
        <attributes>
            <datafield tag="830">
                <!-- Joining title $a and name of part $p to one string -->
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='830'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>
        </relationships>
    </entity>

    <!--Expressions-->
    <entity tag="130" condition="*:subfield/@code = '1w'" type="http://rdaregistry.info/Elements/c/C10006" templatename="MARC21-130-Expression" label="Expression">
        <note>Expression for the title in the 240</note>
        <attributes>
            <controlfield tag="008"  type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression" select="substring(., 36, 3)"/>
            <!-- sometimes we find the expression title in 740 field..... -->
            <datafield tag="740" condition="@ind2 = '0' and frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20312" select="frbrizer:trim(.)" label="has title"/>
            </datafield>
            <datafield tag="041" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="e" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="j" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
            </datafield>
            <datafield tag="130">
                <subfield code="s" type="http://rdaregistry.info/Elements/e/P20003" label="has other distinguishing characteristic of the expression"/>
                <subfield code="l" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="g" type="http://rdaregistry.info/Elements/e/P20312" label="has title"/>
            </datafield>
            <datafield tag="336">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20001" label="has content type"/>
            </datafield>
        </attributes>
        <label select="string-join((*:datafield[@tag='336']/*:subfield[@code='a'], *:datafield[@tag='041']/*:subfield[@code=('a', 'd')][1]), '/')"/>
        <key order="3">
            <element>(frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/e/P20231']/@href))[1]</element>
            <element>'/'</element>
            <element>lower-case((//.[@type='http://rdaregistry.info/Elements/e/P20006'])[1])</element>
            <element>'/'</element>
            <element>lower-case((*:datafield/*:subfield[@type='http://rdaregistry.info/Elements/e/P20001']/replace(., ' ', ''))[1])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/e/P20059" itype="http://rdaregistry.info/Elements/m/P30139" label="has manifestation of expression" ilabel="has expression manifested">
                <target entity="MARC21-001-Manifestation"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="240" condition="*:subfield/@code = '1w'" type="http://rdaregistry.info/Elements/c/C10006" templatename="MARC21-240-Expression" label="Expression">
        <note>Expression for the title in the 240</note>
        <attributes>
            <!--<controlfield tag="008" type="{frbrizer:marc21rdftype(.)}"/>-->
            <!-- sometimes we find the expression title in 740 field..... -->
            <controlfield tag="008"  type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression" select="substring(., 36, 3)"/>
            <datafield tag="041" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="e" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="j" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
            </datafield>
            <datafield tag="240">
                <subfield code="s" type="http://rdaregistry.info/Elements/e/P20003" label="has other distinguishing characteristic of the expression"/>
                <subfield code="l" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="g" type="http://rdaregistry.info/Elements/e/P20312" label="has title"/>
            </datafield>
            <datafield tag="336">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20001" label="has content type"/>
            </datafield>
        </attributes>
        <label select="string-join((*:datafield[@tag='336']/*:subfield[@code='a'], *:datafield[@tag='041']/*:subfield[@code=('a', 'd')][1]), '/')"/>
        <key order="3">
            <element>(frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/e/P20231']/@href))[1]</element>
            <element>'/'</element>
            <element>lower-case((//.[@type='http://rdaregistry.info/Elements/e/P20006'])[1])</element>
            <element>'/'</element>
            <element>lower-case((*:datafield/*:subfield[@type='http://rdaregistry.info/Elements/e/P20001']/replace(., ' ', ''))[1])</element>
       </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/e/P20059" itype="http://rdaregistry.info/Elements/m/P30139" label="has manifestation of expression" ilabel="has expression manifested">
                <target entity="MARC21-001-Manifestation"/>
            </relationship>
        </relationships>
    </entity>
    
    <!--Expressions-->
    <entity tag="245" type="http://rdaregistry.info/Elements/c/C10006" templatename="MARC21-245-Expression" label="Expression" condition="false()">
        <note>Expression for the title in the 245</note>
        <attributes>
            <controlfield tag="007"  type="http://rdaregistry.info/Elements/e/P20001" label="has content type" select="substring(., 1, 1)"/>
            <controlfield tag="008"  type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression" select="substring(., 36, 3)"/>
            <!-- sometimes we find the expression title in 740 field..... -->
            <datafield tag="740" condition="@ind2 = '0' and frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20312" select="frbrizer:trim(.)" label="has title"/>
            </datafield>
            <datafield tag="041" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="e" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="j" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
            </datafield>
            <datafield tag="245">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20312" label="has title" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'b'])), ' : ')" />
            </datafield>
            <datafield tag="336">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20001" label="has content type"/>
            </datafield>
        </attributes>
        <label select="string-join((*:datafield[@tag='336']/*:subfield[@code='a'], *:datafield[@tag='041']/*:subfield[@code=('a', 'd')][1]), '/')"/>
        <key order="3">
            <element>(frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/e/P20231']/@href))[1]</element>
            <element>'/'</element>
            <element>lower-case((//.[@type='http://rdaregistry.info/Elements/e/P20006'])[1])</element>
            <element>'/'</element>
            <element>lower-case((*:datafield/*:subfield[@type='http://rdaregistry.info/Elements/e/P20001']/replace(., ' ', ''))[1])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/e/P20059" itype="http://rdaregistry.info/Elements/m/P30139" label="has manifestation of expression" ilabel="has expression manifested">
                <target entity="MARC21-001-Manifestation"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="700" condition="*:subfield/@code = '1w' and @ind2='2' and *:subfield[@code='t'] and not(*:subfield[@code='i'])" type="http://rdaregistry.info/Elements/c/C10006" templatename="MARC21-700-Expression" label="Expression">
        <note>Expression associated with work identified by 700$t (only creating expressions for analytical entries)</note>
        <attributes>
            <controlfield tag="008"  type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression" select="substring(., 36, 3)"/>
            <datafield tag="041" condition="frbrizer:linked($anchor_field, .) and not(exists($anchor_field/*:subfield[@code = 'l']))">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="e" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="j" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
            </datafield>
            <datafield tag="336" condition="frbrizer:linked($anchor_field, .) and (not($anchor_field/*:subfield[@code='h']))">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20001" label="has content type"/>
            </datafield>
            <datafield tag="700">
                <subfield code="h" type="http://rdaregistry.info/Elements/e/P20001" label="has content type"/>
                <subfield code="l" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="g" type="http://rdaregistry.info/Elements/e/P20312" label="has title"/>
                <subfield code="t" type="http://rdaregistry.info/Elements/e/P20312" condition="not(exists($record/*:datafield[@tag = '740' and frbrizer:linked($anchor_field, .)]))" label="has title"/>
                <subfield code="s" type="http://rdaregistry.info/Elements/e/P20003" label="has other distinguishing characteristic of the expression"/>
            </datafield>
        </attributes>
        <label select="string-join((*:datafield[@tag='336']/*:subfield[@code='a'], *:datafield[@tag='041']/*:subfield[@code='a']), '/')"/>
        <key order="3">
            <element>(frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/e/P20231']/@href))[1]</element>
            <element>'/'</element>
            <element>lower-case((//.[@type='http://rdaregistry.info/Elements/e/P20006'])[1])</element>
            <element>'/'</element>
            <element>lower-case((*:datafield/*:subfield[@type='http://rdaregistry.info/Elements/e/P20001']/replace(., ' ', ''))[1])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/e/P20059" itype="http://rdaregistry.info/Elements/m/P30139" label="has manifestation of expression" ilabel="has expression manifested">
                <target entity="MARC21-001-Manifestation"/>
            </relationship>
        </relationships>
    </entity>
    
    <!-- MANIFESTATION -->
    <entity tag="001" type="http://rdaregistry.info/Elements/c/C10007" templatename="MARC21-001-Manifestation" label="Manifestation">
        <note>Manifestation</note>
        <attributes>
            <controlfield tag="001" type="http://marc21rdf.info/elements/marc/M001"/>
            <datafield tag="020">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30004" select="concat('urn:isbn:', replace(., '\D', ''))" label="has identifier for the manifestation"/>
            </datafield>
            <datafield tag="022">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30004" select="concat('urn:issn:', ./replace(., '\D', ''))" label="has identifier for the manifestation"/>
            </datafield>
            <datafield tag="024">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30004" select="concat('urn:',frbrizer:idprefix(../@ind1) ,':', replace(., '\D', ''))" label="has identifier for the manifestation"/>
            </datafield>
            <datafield tag="245">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30156" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'b'])), ' : ')" label="has title proper"/>
                <!-- <subfield code="b" type="frbrer:P3020" subtype="subtitle" label="has title of the manifestation"/>-->
                <subfield code="c" type="http://rdaregistry.info/Elements/m/P30117" select="frbrizer:trim(.)" label="has statement of responsibility"/>
            </datafield>
            <datafield tag="250">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30107" label="has edition statement"/>
            </datafield>
            <datafield tag="260">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30088" select="frbrizer:trim(.)" label="has place of publication"/>
                <subfield code="b" type="http://rdaregistry.info/Elements/m/P30083" select="frbrizer:trim(.)" label="has publisher"/>
                <subfield code="c" type="http://rdaregistry.info/Elements/m/P30011" select="frbrizer:trim(.)" label="has date of publication"/>
                <subfield code="e" type="http://rdaregistry.info/Elements/m/P30111" select="frbrizer:trim(.)" label="has publication statement"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/m/P30175" select="frbrizer:trim(.)" label="has manufacturers name"/>
                <subfield code="g" type="http://rdaregistry.info/Elements/m/P30109" select="frbrizer:trim(.)" label="has manufacture statement"/>
            </datafield>
            <datafield tag="300">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30182" label="has extent"/>
                <!--<subfield code="b" type="http://marc21rdf.info/elements/marc/M30000b" label="other physical details"/>-->
                <subfield code="c" type="http://rdaregistry.info/Elements/m/P30169" label="has dimensions"/>
                <!--<subfield code="e" type="http://marc21rdf.info/elements/marc/M30000e" label="accompanying material"/> -->
            </datafield>
            <datafield tag="337">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30001" select="frbrizer:trim(.)" label="has carrier type"/>
            </datafield>
            <datafield tag="338">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30002" select="frbrizer:trim(.)" label="has media type"/>
            </datafield>
            <datafield tag="490">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30106" select="frbrizer:trim(.)" label="has series statement"/>
                <subfield code="v" type="http://rdaregistry.info/Elements/m/P30165" label="has numbering of serials"/>
                <subfield code="l" type="http://marc21rdf.info/elements/marc/M49000l"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>if ((*:datafield[@tag=("020","024")][1]/*:subfield[@code='a'])[1]) then (*:datafield[@tag=("020","024")][1]/*:subfield[@code='a'])[1]/replace(., '\(.*\)', '') else concat('http://example.org/', *:controlfield[@tag='001'])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/m/P30020" itype="http://rdaregistry.info/Elements/m/P30033" label="is contained in (manifestation)" ilabel="is container for (manifestation)">
                <!--<target entity="MARC21-490-Manifestation"/>-->
                <target entity="MARC21-773-Manifestation"/>
            </relationship>
        </relationships>
    </entity>
    
    <!--<entity tag="490" type="http://rdaregistry.info/Elements/c/C10007" templatename="MARC21-490-Manifestation" label="Manifestation">
        <attributes>
            <datafield tag="490">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30156" label="has title proper"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>concat('http://example.org/', (*:datafield[@tag='490'][1]/*:subfield[@code='a']/replace(., '\W', ''))[1])</element>
        </key>
        <relationships>
        </relationships>
    </entity>-->
    
    
    <entity tag="773" type="http://rdaregistry.info/Elements/c/C10007" templatename="MARC21-773-Manifestation" label="Manifestation">
        <attributes>
            <datafield tag="773">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30156" label="has title proper"/>
                <subfield code="w" type="http://rdaregistry.info/Elements/m/P30004" label="identifier - record number"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>concat('http://example.org/', (*:datafield[@tag='773'][1]/*:subfield[@code='w']/replace(., '\W', ''))[1])</element>
        </key>
        <relationships>
        </relationships>
    </entity>
    
    <stylesheet xmlns:frbrizer="http://idi.ntnu.no/frbrizer/" xmlns:xs="http://www.w3.org/2001/XMLSchema" version="2.0">
        
        <xsl:function xmlns:local="http://idi.ntnu.no/frbrizer/"
            xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
            xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
            name="local:create-personid">
            <xsl:param name="datafield"/>
            <xsl:choose>
                <xsl:when test="$datafield/*:subfield[@code = '1p']">
                    <xsl:value-of select="($datafield/*:subfield[@code = '1p'])[1]"/>
                </xsl:when>
                <xsl:otherwise>
                    <xsl:value-of select="replace(lower-case(string-join(($datafield/*:subfield[@code = 'a'], $datafield/*:subfield[@code = 'b'], $datafield/*:subfield[@code = 'c'], $datafield/*:subfield[@code = 'd']), '')), '[^A-Za-z0-9]', '')"/>
                </xsl:otherwise>
            </xsl:choose>
        </xsl:function>
        
        <xsl:function xmlns:local="http://idi.ntnu.no/frbrizer/"
            xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
            xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
            name="local:create-workid">
            <xsl:param name="datafield"/>
            <xsl:param name="relationship"/>
            <xsl:choose>
                <xsl:when test="$datafield/*:subfield[@code = '1w']">
                    <xsl:value-of select="($datafield/*:subfield[@code = '1w'])[1]"/>
                </xsl:when>
                <xsl:when test="$datafield[@tag='240']">
                    <xsl:variable name="value" select="replace(lower-case(string-join(($datafield/*:subfield[@code = 'a'], $datafield/*:subfield[@code = 'k'], $datafield/*:subfield[@code = 'n'], $datafield/*:subfield[@code = 'o'], $datafield/*:subfield[@code = 'p']), '')), '[^A-Za-z0-9]', '')"/>
                    <xsl:value-of select="$relationship||'/'||$value"/>
                </xsl:when>
                <xsl:when test="$datafield[@tag='245']">
                    <xsl:variable name="value" select="replace(lower-case(string-join(($datafield/*:subfield[@code = 'a'], $datafield/*:subfield[@code = 'b']), '')), '[^A-Za-z0-9]', '')"/>
                    <xsl:value-of select="$relationship||'/'||$value"/>
                </xsl:when>
                <xsl:when test="$datafield[@tag=('600', '700', '800')]">
                    <xsl:variable name="value" select="replace(lower-case(string-join(($datafield/*:subfield[@code = 't'], $datafield/*:subfield[@code = 'k'], $datafield/*:subfield[@code = 'n'], $datafield/*:subfield[@code = 'o'], $datafield/*:subfield[@code = 'p']), '')), '[^A-Za-z0-9]', '')"/>
                    <xsl:value-of select="$relationship||'/'||$value"/>
                </xsl:when>
                <xsl:otherwise>
                    <xsl:value-of select="$relationship||'/noidentifier'"/>
                </xsl:otherwise>
            </xsl:choose>
        </xsl:function>
        
        <xsl:function name="frbrizer:linked" as="xs:boolean">
            <!-- returns true if the two fields have the same marc 21 link ($8), or if there is no linking subfields in target or source -->
            <xsl:param name="anchor" as="element()"/>
            <xsl:param name="target" as="element()"/>
            <xsl:value-of select="(some $x in $anchor/subfield[@code='8'] satisfies $x = $target/subfield[@code='8']) or (not(exists($anchor/subfield[@code='8'])) or not(exists($target/subfield[@code='8'])))"/>  
            <!--<xsl:value-of select=" (some $x in $anchor/*:subfield[@code = '8'] satisfies $x = $target/*:subfield[@code = '8']) or (not(exists($target/*:subfield[@code = '8'])))"/>-->
        </xsl:function>
        
        <xsl:function name="frbrizer:linked-strict" as="xs:boolean">
            <!-- returns true if the two fields have the same marc 21 link ($8) -->
            <xsl:param name="anchor" as="element()"/>
            <xsl:param name="target" as="element()"/>
            <xsl:value-of select="some $x in $anchor/*:subfield[@code = '8'] satisfies $x = $target/*:subfield[@code = '8']"/>
        </xsl:function>
        
        <xsl:function name="frbrizer:trim" as="xs:string*">
            <xsl:param name="value" as="element()*"/>
            <xsl:for-each select="$value">
                <xsl:value-of select="replace(., '[ \.,/:]+$', '')"/>
            </xsl:for-each>
        </xsl:function>
        <xsl:function name="frbrizer:idprefix">
            <xsl:param name="value"/>
            <xsl:choose>
                <xsl:when test="$value = '0'">
                    <xsl:value-of select="'isrc'"/>
                </xsl:when>
                <xsl:when test="$value = '1'">
                    <xsl:value-of select="'upc'"/>
                </xsl:when>
                <xsl:when test="$value = '2'">
                    <xsl:value-of select="'ismn'"/>
                </xsl:when>
                <xsl:when test="$value = '3'">
                    <xsl:value-of select="'ian'"/>
                </xsl:when>
                <xsl:when test="$value = '4'">
                    <xsl:value-of select="'sici'"/>
                </xsl:when>
                <xsl:otherwise>
                    <xsl:value-of select="'unknown'"/>
                </xsl:otherwise>
            </xsl:choose>
        </xsl:function>

    </stylesheet>
</templates>